// Youtube code adapted from here: https://github.com/BloxyLabs/ESP32_YouTubeCounter/blob/main/ESP32_YT_Counter_V2/ESP32_YT_Counter_V2.ino
// Edit 01/03/2026: got help from Google Gemini to tune the code
/*
Franzininho WiFi (ESP32-S2), WeAct 2.9" e-paper display
D/C 0
CS 1
Busy 2
Res 3
SDA 35
SCL 36
*/

#include "Adafruit_EPD.h"
#include <Adafruit_GFX.h> // Core graphics library

#include <Wire.h>
#include <SHT21.h>  // include SHT21 library

SHT21 sht; 

// Inclusão da(s) biblioteca(s)
#include <WiFi.h>       // Biblioteca nativa do ESP32
#include <WiFiClientSecure.h>
#include <HTTPClient.h> // Biblioteca nativa do ESP32
#include <ArduinoJson.h>

#include <YoutubeApi.h>

// Thermometer Icon (16x16)
const unsigned char thermometer_icon[] PROGMEM = {
  0x03, 0x80, 0x04, 0x40, 0x04, 0x40, 0x04, 0x40, 0x04, 0x40, 0x04, 0x40, 0x04, 0x40, 0x09, 0x20,
  0x11, 0x10, 0x11, 0x10, 0x11, 0x10, 0x11, 0x10, 0x09, 0x20, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00
};

// YouTube-style Play Icon (16x16)
const unsigned char youtube_icon[] PROGMEM = {
  0x7f, 0xfe, 0x80, 0x01, 0x80, 0x01, 0x87, 0x01, 0x87, 0x81, 0x87, 0xc1, 0x87, 0xe1, 0x87, 0xc1,
  0x87, 0x81, 0x87, 0x01, 0x80, 0x01, 0x80, 0x01, 0x7f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// Humidity/Water Droplet Icon (16x16)
const unsigned char humidity_icon[] PROGMEM = {
  0x01, 0x00, 0x01, 0x00, 0x03, 0x80, 0x03, 0x80, 0x07, 0xc0, 0x07, 0xc0, 0x0f, 0xe0, 0x0f, 0xe0,
  0x1f, 0xf0, 0x1f, 0xf0, 0x1f, 0xf0, 0x1f, 0xf0, 0x1f, 0xf0, 0x0f, 0xe0, 0x07, 0xc0, 0x00, 0x00
};

const unsigned char mylogo[] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xf0, 0x60, 0xc1, 
	0x06, 0x0c, 0x30, 0x60, 0x83, 0x06, 0x18, 0x30, 0x41, 0xf0, 0xf0, 0x70, 0xc1, 0x06, 0x0c, 0x38, 
	0x60, 0x83, 0x0e, 0x1c, 0x30, 0x41, 0xf0, 0xf0, 0x70, 0xc1, 0x06, 0x0c, 0x38, 0x60, 0x83, 0x0e, 
	0x1c, 0x30, 0x41, 0xf0, 0xf0, 0x70, 0xc1, 0x06, 0x0c, 0x38, 0x60, 0x83, 0x0e, 0x1c, 0x30, 0x41, 
	0xf0, 0xf0, 0x70, 0xc1, 0x06, 0x0c, 0x38, 0x60, 0x83, 0x0e, 0x1c, 0x30, 0x41, 0xf0, 0xc0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0xc0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x01, 0x80, 0x70, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
	0xe0, 0x70, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x70, 0xc0, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x18, 0x70, 0xc0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x8c, 0x70, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xcc, 0x70, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x08, 0x46, 0x70, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x66, 0x70, 
	0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x26, 0x70, 0xc0, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x32, 0x70, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x33, 0x32, 0x70, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x10, 0x00, 0x70, 0xf8, 0x3f, 0x01, 0x80, 0x00, 0x00, 0x00, 0x08, 0x00, 0x06, 0x00, 0x00, 
	0x70, 0xf8, 0x3f, 0x01, 0x88, 0x00, 0x00, 0x00, 0x08, 0x00, 0x06, 0x00, 0x00, 0x70, 0xf8, 0x20, 
	0x00, 0x08, 0x00, 0x00, 0x00, 0x08, 0x00, 0x06, 0x00, 0x00, 0x70, 0xf8, 0x20, 0x5d, 0x9f, 0x7e, 
	0x3e, 0x3f, 0x08, 0x07, 0xc7, 0xe0, 0x00, 0x70, 0xf0, 0x20, 0x61, 0x88, 0x06, 0x63, 0x39, 0x88, 
	0x08, 0x47, 0x30, 0x00, 0x70, 0xe0, 0x3e, 0x61, 0x88, 0x04, 0x41, 0x30, 0x88, 0x00, 0x66, 0x10, 
	0x00, 0x70, 0xc0, 0x20, 0x41, 0x88, 0x08, 0x7f, 0x30, 0x88, 0x07, 0xe6, 0x18, 0x00, 0x70, 0xc0, 
	0x20, 0x41, 0x88, 0x10, 0x40, 0x30, 0x88, 0x0c, 0x66, 0x18, 0x00, 0x70, 0xc0, 0x20, 0x41, 0x88, 
	0x30, 0x40, 0x30, 0x88, 0x08, 0x66, 0x18, 0x00, 0x70, 0xc0, 0x20, 0x41, 0x88, 0x60, 0x60, 0x30, 
	0x88, 0x08, 0x66, 0x10, 0x00, 0x70, 0xc0, 0x20, 0x41, 0x8f, 0x7e, 0x3f, 0x30, 0x8f, 0xef, 0xe7, 
	0xf0, 0x00, 0x70, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 
	0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0xc0, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x70, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x70, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0xf0, 0x70, 
	0xc1, 0x06, 0x08, 0x38, 0x60, 0x83, 0x0e, 0x1c, 0x30, 0x41, 0xf0, 0xf0, 0x70, 0xc1, 0x06, 0x0c, 
	0x38, 0x60, 0x83, 0x0e, 0x1c, 0x30, 0x41, 0xf0, 0xf0, 0x70, 0xc1, 0x06, 0x0c, 0x38, 0x60, 0x83, 
	0x0e, 0x1c, 0x30, 0x41, 0xf0, 0xf0, 0x70, 0xc1, 0x06, 0x0c, 0x38, 0x60, 0x83, 0x0e, 0x1c, 0x30, 
	0x41, 0xf0, 0xf0, 0x60, 0xc1, 0x06, 0x0c, 0x30, 0x60, 0x83, 0x06, 0x18, 0x30, 0x41, 0xf0, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0
};

//double subs = 0;
long subs;

// Configurações da rede WiFi à se conectar
const char* ssid = "";
const char* password = "";
const char* freeCurrencyAPIHere = "";
String payload;
String payload2;

HTTPClient http; // o objeto da classe HTTPClient
HTTPClient http2; // o objeto da classe HTTPClient

#ifdef ARDUINO_ADAFRUIT_FEATHER_RP2040_THINKINK // detects if compiling for
                                                // Feather RP2040 ThinkInk
#define EPD_DC PIN_EPD_DC       // ThinkInk 24-pin connector DC
#define EPD_CS PIN_EPD_CS       // ThinkInk 24-pin connector CS
#define EPD_BUSY PIN_EPD_BUSY   // ThinkInk 24-pin connector Busy
#define SRAM_CS -1              // use onboard RAM
#define EPD_RESET PIN_EPD_RESET // ThinkInk 24-pin connector Reset
#define EPD_SPI &SPI1           // secondary SPI for ThinkInk
#else
#define EPD_DC 0
#define EPD_CS 1
#define EPD_BUSY 2 // can set to -1 to not use a pin (will wait a fixed delay)
#define SRAM_CS -1
#define EPD_RESET 3  // can set to -1 and share with microcontroller Reset!
#define EPD_SPI &SPI // primary SPI
#endif

const char* apiKey   = "";
const char* channelIdNet = ""; // channel ID for the first channel
long subscribers= 0;
long repeatTime= 0;
bool startup= true;

/* Uncomment the following line if you are using 1.54" tricolor EPD */
// Adafruit_IL0373 display(152, 152, EPD_DC, EPD_RESET, EPD_CS, SRAM_CS,
// EPD_BUSY, EPD_SPI);

/* Uncomment the following line if you are using 1.54" monochrome EPD */
// Adafruit_SSD1608 display(200, 200, EPD_DC, EPD_RESET, EPD_CS, SRAM_CS,
// EPD_BUSY, EPD_SPI);

/* Uncomment the following line if you are using 2.13" tricolor EPD */
//Adafruit_IL0373 display(212, 104, EPD_DC, EPD_RESET, EPD_CS, SRAM_CS, EPD_BUSY,
//                        EPD_SPI);
//#define FLEXIBLE_213

/* Uncomment the following line if you are using 2.13" monochrome 250*122 EPD */
// Adafruit_SSD1675 display(250, 122, EPD_DC, EPD_RESET, EPD_CS, SRAM_CS,
// EPD_BUSY, EPD_SPI);

/* Uncomment the following line if you are using 2.7" tricolor or grayscale EPD
 */
// Adafruit_IL91874 display(264, 176, EPD_DC, EPD_RESET, EPD_CS, SRAM_CS,
// EPD_BUSY, EPD_SPI);

/* Uncomment the following line if you are using 2.9" EPD */
// Adafruit_IL0373 display(296, 128, EPD_DC, EPD_RESET, EPD_CS, SRAM_CS,
// EPD_BUSY, EPD_SPI); #define FLEXIBLE_290

/* Uncomment the following line if you are using 4.2" tricolor EPD */
// Adafruit_IL0398 display(300, 400, EPD_DC, EPD_RESET, EPD_CS, SRAM_CS,
// EPD_BUSY, EPD_SPI);

// Uncomment the following line if you are using 2.9" EPD with SSD1680
// THIS IS MY DISPLAY MODEL, YOURS MAY VARY
Adafruit_SSD1680 display(296, 128, EPD_DC, EPD_RESET, EPD_CS, SRAM_CS,
EPD_BUSY, EPD_SPI);

float temp; 	// variable to store temperature
float humidity; // variable to store hemidity

void setup() {
  // put your setup code here, to run once:
  display.begin();
  display.clearBuffer();
  Wire.begin();		// begin Wire(I2C)
  Serial.begin(115200);

  WiFi.disconnect(); // Desconecta do WiFI se já houver alguma conexão
  WiFi.mode(WIFI_STA); // Configura o ESP32 para o modo de conexão WiFi Estação
  Serial.println("[SETUP] Tentando conexão com o WiFi...");
  WiFi.begin(ssid, password); // Conecta-se à rede
  if (WiFi.waitForConnectResult() == WL_CONNECTED) // aguarda até que o módulo se
    //                                                  conecte ao ponto de acesso
  {
    Serial.println("[SETUP] WiFi iniciado com sucesso!");
  } else
  {
    Serial.println("[SETUP] Houve falha na inicialização do WiFi. Reiniciando ESP.");
    ESP.restart();
  }
   
}

void loop() {
  double conversion = 0;
  double conversion2 = 0;

  if((millis() - repeatTime > 360000) || startup == true){ // six minutes per loop entrance
    repeatTime= millis();
    startup= false;
    // --- START CURRENCY BLOCK ---
    // The curly braces {} ensure all memory used here is freed before YouTube starts
    {
      HTTPClient http;
      Serial.println("[HTTP] Iniciando requisição de moedas...");
      
      // Request 1: BRL
      http.begin("https://api.freecurrencyapi.com/v1/latest?apikey=yourAPIkeyHere");
      int httpCode = http.GET();

      if (httpCode == HTTP_CODE_OK) {
        String payload = http.getString();
        DynamicJsonDocument doc(2048);
        DeserializationError error = deserializeJson(doc, payload);
        if (!error) {
          conversion = doc["data"]["BRL"].as<double>();
          Serial.print("BRL: "); Serial.println(conversion, 4);
        }
      }
      http.end();

    } 
    // --- END CURRENCY BLOCK (Memory is now clean) ---

    // Get Sensors
    temp = sht.getTemperature();
    humidity = sht.getHumidity();
    Serial.print("Sensor: "); Serial.print(temp); Serial.print("C | "); Serial.println(humidity);

    // Get YouTube (This now has much more RAM available)
    getSubscribersNet();

    Serial.print("IP Local: "); Serial.println(WiFi.localIP());

    // --- UPDATE DISPLAY ---
    display.clearBuffer();    
    display.setTextColor(EPD_BLACK);
    display.setTextSize(2);
    display.drawBitmap(75, 5, mylogo, 100, 45, EPD_BLACK);
    display.drawBitmap(120, 55, thermometer_icon, 16, 16, EPD_BLACK);
    display.drawBitmap(120, 70, humidity_icon, 16, 16, EPD_BLACK);
    //display.println("$$");
    display.drawBitmap(120, 105, youtube_icon, 16, 16, EPD_BLACK);

    display.setCursor(5, 55);
    display.setTextSize(2); // Small text for data to ensure it fits
    display.print("Temp          :"); display.print(temp); display.println(" C"); 
    display.print("Humidity       :"); display.print(humidity); display.println(" %");
    display.print("BRL ->> US$    :"); display.println(conversion, 2);
    display.print("Subs           :"); display.println(subscribers);
    
    //Serial.println("Updating E-Paper...");
    display.display();

    // Wait 1 minute before next cycle
  }
}
// This function is for a single youtube channel
void getSubscribersNet() {
  Serial.println("--- Starting YouTube Update ---");
  WiFiClientSecure *client = new WiFiClientSecure;
  
  if (client) {
    client->setInsecure(); 
    HTTPClient http;
    String url = "https://www.googleapis.com/youtube/v3/channels?part=statistics&id=" 
                 + String(channelIdNet) + "&key=" + String(apiKey);

    if (http.begin(*client, url)) {
      int httpCode = http.GET();
      Serial.print("YouTube HTTP Code: ");
      Serial.println(httpCode);

      if (httpCode == 200) {
        String payloadYT = http.getString();
        DynamicJsonDocument doc(2048); 
        DeserializationError error = deserializeJson(doc, payloadYT);

        if (!error) {
          if (doc["items"].size() > 0) {
            const char* countStr = doc["items"][0]["statistics"]["subscriberCount"];
            subscribers = atol(countStr); 
            Serial.print("YouTube Success! Subscribers: ");
            Serial.println(subscribers);
          } else {
            Serial.println("YouTube Error: items array is empty (Check Channel ID)");
          }
        } else {
          Serial.print("YouTube JSON Error: ");
          Serial.println(error.c_str());
        }
      } else {
        Serial.print("YouTube GET Failed, error: ");
        Serial.println(http.errorToString(httpCode).c_str());
      }
      http.end(); // Move this here so it always closes correctly
    } else {
      Serial.println("YouTube Connection Failed at .begin()");
    }
    delete client; 
  }
  Serial.println("--- End YouTube Update ---");
}